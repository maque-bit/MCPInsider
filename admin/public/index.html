<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Insider Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="max-w-6xl mx-auto p-6">
        <header class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i data-lucide="settings"></i> MCP Insider Admin
            </h1>
            <div id="status-indicator" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-200">
                Loading...
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex border-b mb-6">
            <button class="tab-btn active px-4 py-2 font-medium text-gray-600 hover:text-blue-600"
                onclick="switchTab('control')">Control Panel</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-blue-600"
                onclick="switchTab('data')">Data Maintenance</button>
        </div>

        <!-- Control Panel Tab -->
        <div id="control" class="tab-content active space-y-8">
            <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Operations</h2>
                <div class="flex gap-4">
                    <button onclick="runScript('collect')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Run Collector
                    </button>
                    <button onclick="runScript('analyze')"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md flex items-center gap-2">
                        <i data-lucide="cpu" class="w-4 h-4"></i> Run Analyzer
                    </button>
                    <button onclick="deployToGitHub()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md flex items-center gap-2 ml-auto shadow-sm">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Deploy to Live Site
                    </button>
                </div>
                <!-- Output Log Viewer placeholder -->
                <div class="mt-4">
                    <pre id="log-output"
                        class="bg-gray-900 text-gray-100 p-4 rounded-md h-40 overflow-y-auto text-sm hidden"></pre>
                </div>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Settings</h2>
                <div class="space-y-4 max-w-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium block">Maintenance Mode</span>
                            <span class="text-sm text-gray-500">Temporarily hide the site from public view.</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="setting-maintenance" class="sr-only peer"
                                onchange="saveSettings()">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium block">Auto Publish</span>
                            <span class="text-sm text-gray-500">Skip draft stage and publish analysis
                                immediately.</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="setting-auto-publish" class="sr-only peer"
                                onchange="saveSettings()">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium block">Retention Period (Days)</span>
                            <span class="text-sm text-gray-500">How long to keep analyzed data.</span>
                        </div>
                        <input type="number" id="setting-retention" class="border rounded px-2 py-1 w-20 text-center"
                            onchange="saveSettings()">
                    </div>
                </div>
            </section>
        </div>

        <!-- Data Maintenance Tab -->
        <div id="data" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Analyzed Projects</h2>
                    <input type="text" id="search-data" placeholder="Search projects..."
                        class="border rounded px-3 py-1 text-sm w-64" onkeyup="filterData()">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="data-table">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-2 font-medium text-gray-600">Name</th>
                                <th class="px-4 py-2 font-medium text-gray-600">Status</th>
                                <th class="px-4 py-2 font-medium text-gray-600">Analyzed At</th>
                                <th class="px-4 py-2 font-medium text-gray-600 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-list" class="divide-y">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-xl font-bold" id="modal-title">Edit Project</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4 flex-1" id="modal-content">
                <!-- Inputs populated by JS -->
            </div>
            <div class="p-6 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                <button onclick="closeModal()"
                    class="px-4 py-2 border rounded-md text-gray-600 hover:bg-gray-100">Cancel</button>
                <button onclick="saveEdit()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let appData = [];
        let currentEditUrl = '';

        // UI Helpers
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            if (tabId === 'data') loadData();
        }

        function showLog(text, isError = false) {
            const logBox = document.getElementById('log-output');
            logBox.classList.remove('hidden');
            logBox.textContent = text;
            logBox.className = `bg-gray-900 p-4 rounded-md h-40 overflow-y-auto text-sm ${isError ? 'text-red-400' : 'text-gray-100'}`;
        }

        // API Calls
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();
                document.getElementById('setting-maintenance').checked = settings.maintenance_mode;
                document.getElementById('setting-auto-publish').checked = settings.auto_publish;
                document.getElementById('setting-retention').value = settings.retention_days;

                const indicator = document.getElementById('status-indicator');
                if (settings.maintenance_mode) {
                    indicator.textContent = 'MAINTENANCE MODE';
                    indicator.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
                } else {
                    indicator.textContent = 'LIVE';
                    indicator.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
                }
            } catch (e) {
                console.error('Failed to load settings', e);
            }
        }

        async function saveSettings() {
            const saveBtn = document.getElementById('setting-maintenance');
            const statusIndicator = document.getElementById('status-indicator');

            const settings = {
                maintenance_mode: document.getElementById('setting-maintenance').checked,
                auto_publish: document.getElementById('setting-auto-publish').checked,
                retention_days: parseInt(document.getElementById('setting-retention').value, 10)
            };

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const result = await res.json();
                if (!result.success) throw new Error(result.error || 'Failed to save settings');

                // Update UI indicator locally for instant feedback
                if (settings.maintenance_mode) {
                    statusIndicator.textContent = 'MAINTENANCE MODE';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
                } else {
                    statusIndicator.textContent = 'LIVE';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
                }
                console.log('Settings saved successfully');
            } catch (e) {
                showLog(`Save failed: ${e.message}`, true);
                // Revert toggle on failure
                loadSettings();
            }
        }

        async function runScript(type) {
            const logBox = document.getElementById('log-output');
            logBox.classList.remove('hidden');
            logBox.textContent = `Starting ${type}...\n`;
            logBox.className = 'bg-gray-900 p-4 rounded-md h-64 overflow-y-auto text-sm text-gray-100 font-mono';

            const eventSource = new EventSource(`/api/stream/${type}`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                logBox.textContent += data;
                logBox.scrollTop = logBox.scrollHeight;
            };

            eventSource.addEventListener('error', (event) => {
                const data = JSON.parse(event.data);
                const span = document.createElement('span');
                span.className = 'text-red-400';
                span.textContent = data;
                logBox.appendChild(span);
                logBox.scrollTop = logBox.scrollHeight;
            });

            eventSource.addEventListener('done', (event) => {
                const data = JSON.parse(event.data);
                logBox.textContent += `\n--- Finished with code ${data.code} ---\n`;
                logBox.scrollTop = logBox.scrollHeight;
                eventSource.close();
            });

            eventSource.onerror = (err) => {
                console.group('SSE Error');
                console.error(err);
                console.groupEnd();
                eventSource.close();
            };
        }

        async function deployToGitHub() {
            if (!confirm("Are you sure you want to push current data to GitHub and trigger a live deployment?")) return;
            runScript('deploy');
        }

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                const json = await res.json();
                appData = json.projects || [];
                renderData();
            } catch (e) {
                console.error('Failed to load data', e);
            }
        }

        function renderData() {
            const tbody = document.getElementById('data-list');
            const search = document.getElementById('search-data').value.toLowerCase();

            tbody.innerHTML = '';
            appData.filter(p => !search || p.name.toLowerCase().includes(search) || (p.analysis && p.analysis.summary_ja.includes(search)))
                .forEach(p => {
                    const statusColor = p.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const date = p.analyzed_at ? new Date(p.analyzed_at).toLocaleDateString() : '-';
                    const safeUrl = encodeURIComponent(p.url);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${p.name}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${p.status || 'draft'}</span></td>
                    <td class="px-4 py-3 text-gray-500">${date}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editProject('${safeUrl}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded mr-2"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onclick="togglePublish('${safeUrl}')" class="text-green-600 hover:bg-green-50 p-1 rounded mr-2" title="Toggle Publish"><i data-lucide="check-circle" class="w-4 h-4"></i></button>
                        <button onclick="deleteProject('${safeUrl}')" class="text-red-600 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            lucide.createIcons();
        }

        function filterData() {
            renderData();
        }

        // Edit/Actions
        async function togglePublish(safeUrl) {
            const p = appData.find(x => encodeURIComponent(x.url) === safeUrl);
            if (!p) return;
            const newStatus = p.status === 'published' ? 'draft' : 'published';
            await fetch(`/api/data/${safeUrl}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            loadData();
        }

        async function deleteProject(safeUrl) {
            if (!confirm("Are you sure you want to delete this project?")) return;
            await fetch(`/api/data/${safeUrl}`, { method: 'DELETE' });
            loadData();
        }

        function editProject(safeUrl) {
            currentEditUrl = safeUrl;
            const p = appData.find(x => encodeURIComponent(x.url) === safeUrl);
            if (!p) return;

            document.getElementById('modal-title').textContent = `Edit: ${p.name}`;
            const c = document.getElementById('modal-content');

            const analysis = p.analysis || {};

            c.innerHTML = `
                <div>
                    <label class="block text-sm font-medium mb-1">Status</label>
                    <select id="edit-status" class="w-full border rounded p-2">
                        <option value="draft" ${p.status === 'draft' ? 'selected' : ''}>Draft</option>
                        <option value="published" ${p.status === 'published' ? 'selected' : ''}>Published</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Summary (JA)</label>
                    <textarea id="edit-summary" class="w-full border rounded p-2 h-20">${analysis.summary_ja || ''}</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Catchphrase</label>
                    <input type="text" id="edit-catchphrase" class="w-full border rounded p-2" value="${analysis.catchphrase || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Wow Factor</label>
                    <textarea id="edit-wow" class="w-full border rounded p-2 h-16">${analysis.wow_factor || ''}</textarea>
                </div>
            `;

            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function saveEdit() {
            const p = appData.find(x => encodeURIComponent(x.url) === currentEditUrl);
            const status = document.getElementById('edit-status').value;

            const updates = { status };
            if (p.analysis) {
                updates.analysis = {
                    ...p.analysis,
                    summary_ja: document.getElementById('edit-summary').value,
                    catchphrase: document.getElementById('edit-catchphrase').value,
                    wow_factor: document.getElementById('edit-wow').value
                };
            }

            await fetch(`/api/data/${currentEditUrl}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });

            closeModal();
            loadData();
        }

        // Init
        loadSettings();
    </script>
</body>

</html>